## [Elasticsearch](https://www.elastic.co/products/elasticsearch)
### Основные сведения
Основные понятия
* Узел – один сервер elasticsearch.
* Кластер – несколько серверов elasticsearch которые хранят и индексирует один набор данных. Принадлежность узла кластеру определяется именем кластера в настройках узла (по умолчанию все узлы сети присоединяться к кластеру elasticsearch).
* Документ – единица хранения и поиска, состоящая из набора полей и связанных с ними данных.
* Индекс – набор документов (аналог имени БД). То есть добавление данных (документов) в elasticsearch и их поиск производится в индекс и в индексе соответственно.
* Тип – категория документа в индексе (аналог таблицы БД).
* Шард – Индекс разбивается на шарды, соответственно шард это часть индекса (как набора документов). Шард может обрабатываться на другом узле (как реплика), что позволяет масштабировать систему.
* Реплика – копия шарда, которая может обрабатываться на другом узле и обеспечивать отказоустойчивость.
### Установка
Установка производится согласно [официальной документации](https://www.elastic.co/guide/en/elasticsearch/reference/current/_installation.html)
### Администрирование
По умолчанию elasticearch работает на порту 9200 (HTTP).
#### Сбор информации о состоянии elasticsearch
Общая информация об узле
```shell
curl localhost:9200
```
Перечень доступных диагностических полей
```shell
curl localhost:9200/_cat
```
Индексы узла
```shell
curl localhost:9200/_cat/indices?v
```
Состояние работоспособности
```shell
curl localhost:9200/_cat/health?v
```
### Добавление и удаление данных
Управление elasticsearch и манипулирование его данными осуществляется с помощью с [REST](https://ru.wikipedia.org/wiki/REST).
Создать индекс
```shell
curl -XPUT localhost:9200/<индекс>
```
Если после индекс задать параметр pretty (localhost:9200/индекс?pretty) то ответ сервера будет в читабельном виде.
Добавить документ в индекс
```shell
curl -XPUT localhost:9200/<индекс>/<тип>/1 {"поле": "значение"}
```
где **1** это **id** документа, если его не указать, он будет сгенерирован как случайное значение.
Если индекс предварительно не существовал, он будет создан при добавлении документа.
Для замены документа, достаточно добавить в индекс документ с id редактируемого документа.
Обновление документа (можно обновлять и добавлять поля):
```shell
curl -XPOST "localhost:9200/<индекс>/<тип>/1/_update" -d "
{ "doc":
  { "поле" :"значение"}
}"
```
Получить документ
```shell
curl -XGET localhost:9200/<индекс>/<тип>/1
```
Удалить документ (можно несколько, через запрос)
```shell
curl -XDEL localhost:9200/<индекс>/<тип>/1/_
```
Удалить все индексы (вместе с документами)
```shell
curl -XDELETE localhost:9200/_all
```
Пакетная обработка (выполнение нескольких манипуляций с данными в одном HTTP запросе)
```shell
curl -XPOST localhost:9200/<индекс>/<тип>/_bulk {запрос}
```
Дынные (json) могут быть переданы в запрос через файл
```shell
curl -XPOST localhost:9200/<индекс>/<тип>/_bulk --data-binary файл
```
### Поиск данных
Для поиска данных используется Query DSL.
Запрос всех документов (по умолчанию выдаются первые 10 результатов)
```shell
curl localhost:9200/<индекс>/_search?q=*
```
или
```shell
curl -XPOST -H 'Content-Type: application/json" "localhost:9200/<индекс>/_search" -d "
{
  "query": { "match_all": {} }
}"
```
> в имени индекса, в типе, а также в именах и значениях полей можно использовать символ *****, который соответсвует любым символам

#### Параметры запроса
Начиная с какой записи возвращать документы
```shell
"from": 10
```
Количество возвращаемых документов
```shell
"size": 10
```
Сортировать возвращаемые документы по указанному полю
```shell
"sort": { "поле": { "order": "desc" } }
```
Поиск документов, поле которых удовлетворяет услови:
```shell
{
"query": { "match": { "поле": <значение> } }
}'
```
Где значение может содержать несколько термов (осуществляет поиск совпадения с любым из них)
"терм терм2 терм3"
Для поиска совпадения по фразе вместо match используется match_phrase.
В этом случае будет искать совпадение с фразой ("терм терм2 терм3").
Логический запрос
```shell
{
  "query": {
    "bool": {
      "условие": [
        { "match": { "<поле1>": "<значение1>" } },
        { "match": { "<поле2>": "<значение2>" } }
      ]
    }
  }
}
```
Где условие может быть
* must – И
* should – ИЛИ
* not_must – НЕ
### Фильтрация
Запросы с помощью фильтрации выполняются быстрее и они кэшируются, но при таких запросах не происходит расчет релевантности документа запросу.
### Агрегирование
